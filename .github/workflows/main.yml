name: Sync OpenFootball JSON to GCS

on:
  schedule:
    - cron: '0 3 * * 0'   # Every Sunday at 03:00 UTC
  workflow_dispatch:        # Allow manual run

permissions:
  contents: 'read'
  id-token: 'write'

env:
  GCS_BUCKET: soccer-ingest-raw

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      # Authenticate using Workload Identity Federation (Keyless)
      - name: Google Cloud auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/1059253722982/locations/global/workloadIdentityPools/github-wif/providers/github-provider'
          service_account: 'github-ci@soccer-pipeline.iam.gserviceaccount.com'

      # Set up gcloud (includes gsutil)
      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: 'soccer-pipeline' 
          install_components: 'gsutil'

      - name: Install jq (JSON parser)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Clone openfootball repo
        run: |
          git clone --depth 1 https://github.com/openfootball/football.json.git data-source

      - name: Reorganize into year/League Name structure
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          mkdir -p upload

          echo "Starting reorganization..."

          # Iterate through every JSON file in the data-source folder recursively
          # We use a while loop with find to handle paths safely
          find data-source -type f -name "*.json" | while read -r file; do
                  
          # 1. Extract the Directory name (Season)
          dir_path=$(dirname "$file")
          season_name=$(basename "$dir_path")

                  # Skip the root folder or metadata files
                  if [[ "$season_name" == "data-source" ]] || [[ "$season_name" == "user" ]]; then
                    continue
                  fi

                  # 2. Extract Year
                  # If the folder is "2020-21", grab "2020". If it's just "2020", grab "2020".
                  if [[ "$season_name" =~ ^([0-9]{4}) ]]; then
                    year="${BASH_REMATCH[1]}"
                  else
                    # Skip folders that don't look like years (e.g., .git)
                    continue
                  fi

                  # 3. Extract Filename and determine League
                  filename=$(basename "$file")
                  
                  # Try to match the filename to a league code (e.g. 'eng.1.json' -> 'eng')
                  # We look for the first sequence of letters
                  prefix=$(echo "$filename" | grep -oE '^[a-z]+')

                  # If no prefix found, skip
                  if [[ -z "$prefix" ]]; then
                      echo "  Skipping $filename (no prefix found)"
                      continue
                  fi

                  # 4. Check against leagues.json
                  # We look up the prefix in the config/leagues.json file
                  # If the config file doesn't exist, we can't map it.
                  if [[ ! -f "config/leagues.json" ]]; then
                      echo "  ERROR: config/leagues.json not found in repo!"
                      exit 1
                  fi

                  league_name=$(jq -r --arg code "$prefix" '.[$code] // empty' config/leagues.json)

                  if [[ -n "$league_name" ]]; then
                      dest_dir="upload/$year/$league_name"
                      mkdir -p "$dest_dir"
                      cp "$file" "$dest_dir/$filename"
                      echo "  Processed: $year / $league_name / $filename"
                  else
                      # Optional: Uncomment to see what is being skipped
                      # echo "  Skipped: $filename (Code '$prefix' not in leagues.json)"
                      true 
                  fi
                done

                echo "Reorganization complete. Checking upload folder..."
                ls -R upload

      - name: Upload to GCS (rsync)
        run: |
          if [ -d "upload" ] && [ "$(find upload -type f | wc -l)" -gt 0 ]; then
            gsutil -m rsync -r "upload" "gs://${GCS_BUCKET}/"
          else
            echo "Nothing to upload."
          fi