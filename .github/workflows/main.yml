name: Sync OpenFootball JSON → GCS

on:
  schedule:
    - cron: '0 3 * * 0'   # Sundays at 03:00 UTC
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  GCS_BUCKET: soccer-ingest-raw
  OPENFOOTBALL_REPO: https://github.com/openfootball/football.json.git
  LEAGUE_CONFIG: config/leagues.json

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Authenticate to Google Cloud
      - name: Google Cloud Auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/1059253722982/locations/global/workloadIdentityPools/github-wif/providers/github-provider'
          service_account: 'github-ci@soccer-pipeline.iam.gserviceaccount.com'

      # Install gcloud / gsutil
      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: 'soccer-pipeline'
          install_components: 'gsutil'

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Clone OpenFootball JSON
        run: |
          git clone --depth 1 "$OPENFOOTBALL_REPO" data-source

      # --- FIX IS LOCATED IN THIS STEP ---
      - name: Generate league codes → names mapping
        shell: bash
        run: |
          mkdir -p "$(dirname "$LEAGUE_CONFIG")"
          declare -A league_map
          
          # Find all JSON files in data-source
          while IFS= read -r -d '' file; do
            filename=$(basename "$file")
            prefix=$(echo "$filename" | grep -oE '^[a-zA-Z]+')
            [[ -z "$prefix" ]] && continue
            
            # Only first time per prefix
            if [[ -n "${league_map[$prefix]+_}" ]]; then
              continue
            fi
            
            # Extract raw name (e.g., "Algeria | Ligue 1 2024")
            raw_name=$(jq -r '.name // empty' "$file")
            
            if [[ -z "$raw_name" ]]; then
              final_name="$prefix"
            else
              # --- FIX: STRIP YEARS FROM NAME ---
              # This sed regex looks for a space followed by 4 digits (and optional /XX or -XX) at the end of the line and removes it.
              final_name=$(echo "$raw_name" | sed -E 's/ [0-9]{4}(-[0-9]{2}|\/[0-9]{2})?.*$//')
              # Trim any potential trailing spaces
              final_name=$(echo "$final_name" | xargs)
            fi
            
            league_map[$prefix]="$final_name"
          done < <(find data-source -type f -name '*.json' -print0)
          
          # Write JSON
          {
            echo "{"
            first=true
            for prefix in "${!league_map[@]}"; do
              name=${league_map[$prefix]}
              esc_name=$(printf '%s' "$name" | sed 's/"/\\"/g')
              if $first; then
                first=false
              else
                echo ","
              fi
              printf '  "%s": "%s"' "$prefix" "$esc_name"
            done
            echo
            echo "}"
          } > "$LEAGUE_CONFIG"
          
          echo "Generated league config:"
          cat "$LEAGUE_CONFIG"

      - name: Reorganize and validate JSON
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          mkdir -p upload

          for season in data-source/*/ ; do
            season_name=$(basename "$season")
            if [[ "$season_name" =~ ^([0-9]{4}) ]]; then
              year="${BASH_REMATCH[1]}"
            else
              year="$season_name"
            fi

            for file in "$season"/*.json; do
              filename=$(basename "$file")
              prefix=$(echo "$filename" | grep -oE '^[a-zA-Z]+')
              [[ -z "$prefix" ]] && continue

              if [[ ! -s "$file" ]]; then
                echo "ERROR: Empty file: $file"
                continue
              fi

              if ! jq empty "$file" 2>/dev/null; then
                echo "ERROR: Invalid JSON: $file"
                continue
              fi

              if ! jq -e '.name and .rounds' "$file" >/dev/null; then
                echo "WARNING: Missing .name or .rounds in $file"
              fi

              # Pick the latest version
              latest=$(ls "$season"/${prefix}*.json | sort -V | tail -n1)
              if [[ "$file" != "$latest" ]]; then
                echo "Skipping older version: $filename"
                continue
              fi

              # Lookup league name from mapping
              league=$(jq -r --arg code "$prefix" '.[$code] // empty' "$LEAGUE_CONFIG")
              if [[ -z "$league" ]]; then
                echo "Skipping unknown prefix: $prefix"
                continue
              fi

              # Destination: upload/Algeria | Ligue 1/2024/
              dest="upload/$league/$year"
              mkdir -p "$dest"
              cp "$file" "$dest/$filename"
              echo "Staged $filename → $dest/"
            done
          done

      - name: Upload to GCS
        run: |
          if [ -d upload ] && [ "$(find upload -type f | wc -l)" -gt 0 ]; then
            gsutil -m rsync -r upload "gs://${GCS_BUCKET}/"
          else
            echo "Nothing to upload."
          fi